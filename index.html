<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudClear</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            background-color: #000;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        
        @keyframes shake-gentle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        .animate-shake-gentle {
            animation: shake-gentle 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Smartphone = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>
        );
        const Zap = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        );
        const CheckCircle2 = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const ArrowRight = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        );

        // --- Constants ---
        const TOTAL_STORAGE = 512;
        const INITIAL_STATE = { photos: 280.5, apps: 120.2, icloud: 65.4, ios: 12.0, system: 18.5 };
        const CLEARED_STATE = { photos: 120.5, apps: 90.2, icloud: 15.4, ios: 12.0, system: 8.5 };
        const COLORS = { photos: '#FF3B30', apps: '#FF9500', icloud: '#FFCC00', ios: '#8E8E93', system: '#323232', free: '#1C1C1E' };
        const interpolate = (start, end, progress) => start - ((start - end) * progress);

        // --- Components ---
        const StorageBar = ({ currentData, total, savedSpace }) => {
            const used = Object.values(currentData).reduce((a, b) => a + b, 0);
            const free = Math.max(0, total - used);
            const getPercent = (val) => (val / total) * 100;

            return (
                <div className="w-full">
                    <div className="flex justify-between items-end mb-4 px-1">
                        <h2 className="text-3xl font-semibold tracking-tight text-white">iPhone</h2>
                        <div className="text-right">
                            <div className="text-sm font-medium text-gray-400 mb-1">{used.toFixed(1)} GB of {total} GB Used</div>
                        </div>
                    </div>
                    <div className="h-8 w-full bg-black rounded-lg overflow-hidden flex mb-6 relative shadow-inner border border-white/10">
                        <div className="bar-segment h-full transition-all duration-75 ease-linear" style={{ width: `${getPercent(currentData.photos)}%`, backgroundColor: COLORS.photos }}></div>
                        <div className="bar-segment h-full border-l border-black/20 transition-all duration-75 ease-linear" style={{ width: `${getPercent(currentData.apps)}%`, backgroundColor: COLORS.apps }}></div>
                        <div className="bar-segment h-full border-l border-black/20 transition-all duration-75 ease-linear" style={{ width: `${getPercent(currentData.icloud)}%`, backgroundColor: COLORS.icloud }}></div>
                        <div className="bar-segment h-full border-l border-black/20 transition-all duration-75 ease-linear" style={{ width: `${getPercent(currentData.ios)}%`, backgroundColor: COLORS.ios }}></div>
                        <div className="bar-segment h-full border-l border-black/20 transition-all duration-75 ease-linear" style={{ width: `${getPercent(currentData.system)}%`, backgroundColor: COLORS.system }}></div>
                        <div className="flex-1 h-full flex items-center justify-center min-w-0 overflow-hidden">
                            <span className="text-xs font-medium text-gray-400 whitespace-nowrap px-1 transition-opacity duration-300" style={{ opacity: free > 10 ? 1 : 0 }}>{free.toFixed(2)} GB</span>
                        </div>
                    </div>
                    <div className="flex flex-col gap-4">
                        <div className="flex flex-wrap gap-x-4 gap-y-2 text-[12px] font-medium text-gray-400">
                            <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.photos }}></div> Photos</div>
                            <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.apps }}></div> Apps</div>
                            <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.icloud }}></div> iCloud Drive</div>
                            <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.ios }}></div> iOS</div>
                            <div className="flex items-center gap-1.5"><div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: COLORS.system }}></div> System Data</div>
                        </div>
                        {savedSpace > 0 && (
                            <div className="flex items-center gap-2 text-green-400 font-bold animate-in fade-in duration-300 self-end">
                                <Zap className="w-4 h-4 fill-current" /> <span>{savedSpace.toFixed(1)} GB Cleared</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [appState, setAppState] = useState('idle');
            const [progress, setProgress] = useState(0); 
            const [isShaking, setIsShaking] = useState(false);
            const [permissionGranted, setPermissionGranted] = useState(false);
            const requestRef = useRef();
            const isActiveRef = useRef(false);
            const progressRef = useRef(0);

            const currentData = {
                photos: interpolate(INITIAL_STATE.photos, CLEARED_STATE.photos, progress),
                apps: interpolate(INITIAL_STATE.apps, CLEARED_STATE.apps, progress),
                icloud: interpolate(INITIAL_STATE.icloud, CLEARED_STATE.icloud, progress),
                ios: interpolate(INITIAL_STATE.ios, CLEARED_STATE.ios, progress),
                system: interpolate(INITIAL_STATE.system, CLEARED_STATE.system, progress),
            };

            const initialTotal = Object.values(INITIAL_STATE).reduce((a,b) => a+b, 0);
            const currentTotal = Object.values(currentData).reduce((a,b) => a+b, 0);
            const savedSpace = initialTotal - currentTotal;

            const advanceProgress = () => {
                const increment = 0.006; 
                progressRef.current = Math.min(progressRef.current + increment, 1);
                setProgress(progressRef.current);
                if (progressRef.current >= 1) {
                    setAppState('completed');
                    isActiveRef.current = false;
                    setIsShaking(false);
                    if (navigator.vibrate) navigator.vibrate([200]);
                } else {
                    requestRef.current = requestAnimationFrame(advanceProgress);
                }
            };

            const handleInteractionStart = () => {
                if (appState !== 'cleaning') return;
                isActiveRef.current = true;
                setIsShaking(true);
                if (navigator.vibrate) navigator.vibrate(50);
                requestRef.current = requestAnimationFrame(advanceProgress);
            };

            const handleInteractionEnd = () => {
                if (appState !== 'cleaning') return;
                isActiveRef.current = false;
                setIsShaking(false);
                if (requestRef.current) cancelAnimationFrame(requestRef.current);
            };

            useEffect(() => {
                let lastX = 0, lastY = 0, lastZ = 0;
                let lastTime = 0;
                // INCREASED THRESHOLD HERE:
                const threshold = 100; 

                const handleMotion = (e) => {
                    if (appState !== 'cleaning' || isActiveRef.current) return;
                    const current = e.accelerationIncludingGravity;
                    if (!current) return;
                    const currentTime = Date.now();
                    if ((currentTime - lastTime) > 100) {
                        const diffTime = currentTime - lastTime;
                        lastTime = currentTime;
                        const speed = Math.abs(current.x + current.y + current.z - lastX - lastY - lastZ) / diffTime * 10000;
                        if (speed > threshold) {
                            setIsShaking(true);
                            const shakeIncrement = 0.05; 
                            progressRef.current = Math.min(progressRef.current + shakeIncrement, 1);
                            setProgress(progressRef.current);
                            if (progressRef.current >= 1) {
                                setAppState('completed');
                                if (navigator.vibrate) navigator.vibrate([200]);
                            }
                            setTimeout(() => setIsShaking(false), 200);
                        }
                        lastX = current.x;
                        lastY = current.y;
                        lastZ = current.z;
                    }
                };
                if (permissionGranted && appState === 'cleaning') {
                    window.addEventListener('devicemotion', handleMotion);
                }
                return () => { window.removeEventListener('devicemotion', handleMotion); };
            }, [permissionGranted, appState]);

            const requestPermission = async () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    try {
                        const response = await DeviceMotionEvent.requestPermission();
                        if (response === 'granted') setPermissionGranted(true);
                    } catch (e) { console.error(e); }
                } else { setPermissionGranted(true); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-[#1C1C1E] rounded-[2.5rem] p-8 shadow-2xl border border-[#333] relative overflow-hidden">
                        <div className="transition-all duration-500">
                            <StorageBar currentData={currentData} total={TOTAL_STORAGE} savedSpace={savedSpace} />
                        </div>
                        <div className="mt-12 h-48 flex flex-col items-center justify-center relative">
                            {appState === 'idle' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 w-full flex flex-col items-center">
                                    <button onClick={() => { setAppState('cleaning'); requestPermission(); }} className="group relative w-full py-5 bg-blue-600 hover:bg-blue-500 rounded-2xl font-semibold text-xl transition-all active:scale-[0.98] shadow-lg shadow-blue-900/20 flex items-center justify-center gap-3">
                                        Start Cleaning <ArrowRight className="w-5 h-5 group-hover:translate-x-1 transition-transform" />
                                    </button>
                                </div>
                            )}
                            {appState === 'cleaning' && (
                                <div className="animate-in zoom-in duration-300 flex flex-col items-center w-full">
                                    <button onMouseDown={handleInteractionStart} onMouseUp={handleInteractionEnd} onMouseLeave={handleInteractionEnd} onTouchStart={handleInteractionStart} onTouchEnd={handleInteractionEnd}
                                        className={`w-24 h-24 rounded-full flex items-center justify-center mb-6 transition-all duration-200 ${isShaking ? 'bg-orange-500 text-white scale-110 shadow-[0_0_40px_rgba(249,115,22,0.4)] animate-shake-gentle' : 'bg-[#2C2C2E] text-gray-400 hover:bg-[#3A3A3C]'}`}>
                                        <Smartphone className={`w-10 h-10 ${isShaking ? 'fill-current' : ''}`} />
                                    </button>
                                    <h3 className={`text-xl font-semibold mb-2 transition-colors ${isShaking ? 'text-white' : 'text-gray-400'}`}>{isShaking ? "Cleaning..." : "Shake Phone"}</h3>
                                    <p className="text-gray-500 text-sm text-center max-w-[200px]">{permissionGranted ? "Shake your device or hold the icon above to clean." : "Hold the icon above to clean."}</p>
                                </div>
                            )}
                            {appState === 'completed' && (
                                <div className="absolute inset-0 flex flex-col items-center justify-center animate-in zoom-in duration-500">
                                    <div className="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mb-4 shadow-[0_0_30px_rgba(34,197,94,0.5)]">
                                        <CheckCircle2 className="w-10 h-10 text-white" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-white mb-2">All Clear!</h2>
                                    <p className="text-gray-400 mb-6">{savedSpace.toFixed(1)} GB removed</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
